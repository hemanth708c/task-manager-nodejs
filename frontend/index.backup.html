<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Manager ðŸ§ </title>
  <style>
    :root{
      --bg:#0d1117; --panel:#161b22; --muted:#8b949e; --text:#e6edf3;
      --line:#30363d; --ok:#238636; --ok-h:#2ea043; --danger:#da3633; --danger-h:#f85149; --brand:#58a6ff; --warn:#f0a500;
    }
    *{ box-sizing:border-box }
    body{ font-family: Arial, system-ui, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); min-height:100vh; margin:0; display:flex; justify-content:center; padding:40px 16px }
    h1{ color:var(--brand); text-align:center; margin:0 0 18px }
    .wrap{ width: 560px }
    .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:18px; box-shadow:0 4px 20px rgba(0,0,0,.3) }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .grow{ flex:1; min-width:0 }
    input[type=text], input[type=date]{ padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0b131c; color:var(--text); outline:none }
    input[type=text]:focus, input[type=date]:focus{ border-color:#355f96 }
    button{ background:var(--ok); color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700 }
    button:hover{ background:var(--ok-h) }
    .btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--text); font-weight:600 }
    .btn-ghost:hover{ border-color:#3a5e89 }
    .btn-danger{ background:var(--danger) }
    .btn-danger:hover{ background:var(--danger-h) }
    .muted{ color:var(--muted) }
    .tasks{ margin-top:12px; border-top:1px solid var(--line) }
    .task{ display:flex; gap:8px; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--line) }
    .task:last-child{ border-bottom:none }
    .title{ flex:1; min-width:0; outline:none; padding:6px 8px; border-radius:8px }
    .done{ text-decoration:line-through; color:var(--muted) }
    .due{ font-size:12px; color:var(--muted) }
    .overdue{ color: var(--warn); font-weight:700 }
    .error{ background:#2b0e12; color:#ffd1d1; border:1px solid #5b2025; padding:8px 10px; border-radius:8px; margin:8px 0; display:none }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Task Manager ðŸ§ </h1>
    <div id="err" class="error"></div>

    <div class="panel">
      <!-- Add row -->
      <div class="row">
        <input class="grow" type="text" id="taskInput" placeholder="Enter a new task..." />
        <input type="date" id="dueInput" />
        <button id="addBtn">Add</button>
      </div>

      <!-- Toolbar -->
      <div class="row" style="margin-top:10px; justify-content:space-between">
        <div class="row" style="gap:6px">
          <button class="btn-ghost" onclick="setFilter('all')">All</button>
          <button class="btn-ghost" onclick="setFilter('active')">Active</button>
          <button class="btn-ghost" onclick="setFilter('done')">Done</button>
        </div>
        <div class="row" style="gap:6px">
          <span id="count" class="muted">0 items</span>
          <button class="btn-ghost" onclick="markAllDone()">Mark All Done</button>
        </div>
      </div>

      <!-- List -->
      <div id="tasksContainer" class="tasks"></div>
    </div>
  </div>

  <script>
    const API = "http://localhost:3000/tasks";
    let currentFilter = "all";
    const $ = s => document.querySelector(s);

    function showError(msg){ const e=$("#err"); e.textContent=msg||""; e.style.display=msg?"block":"none"; }

    function formatDue(due){
      if(!due) return "";
      const today = new Date(); today.setHours(0,0,0,0);
      const d = new Date(due+"T00:00:00");
      const isOverdue = d < today;
      const label = d.toLocaleDateString();
      return `<span class="due ${isOverdue ? "overdue" : ""}">Due: ${label}${isOverdue ? " (overdue)" : ""}</span>`;
    }

    async function fetchTasks(){
      try{
        showError("");
        const res = await fetch(API);
        if(!res.ok) throw new Error("API error");
        let tasks = await res.json();

        if(currentFilter==="active") tasks = tasks.filter(t=>!t.done);
        if(currentFilter==="done")   tasks = tasks.filter(t=> t.done);

        // sort by due date (nulls last), then by createdAt
        tasks.sort((a,b)=>{
          if(a.due && b.due) return a.due.localeCompare(b.due) || (a.createdAt-b.createdAt);
          if(a.due && !b.due) return -1;
          if(!a.due && b.due) return 1;
          return (a.createdAt-b.createdAt);
        });

        $("#count").textContent = `${tasks.length} item${tasks.length!==1?"s":""}`;

        const c = $("#tasksContainer"); c.innerHTML="";
        if(!tasks.length){ c.innerHTML=`<div class="muted" style="text-align:center; padding:16px">No tasks here.</div>`; return; }

        tasks.forEach(t=>{
          const row = document.createElement("div");
          row.className = "task";
          row.innerHTML = `
            <div style="display:flex; flex-direction:column; gap:4px; flex:1; min-width:0">
              <span class="title ${t.done ? "done":""}" contenteditable="true" data-id="${t.id}">${escapeHtml(t.title)}</span>
              ${formatDue(t.due)}
            </div>
            <div class="row" style="gap:6px">
              <input type="date" value="${t.due || ""}" onchange="updateDue(${t.id}, this.value)" />
              <button onclick="toggleDone(${t.id}, ${t.done})">${t.done ? "Undo":"Done"}</button>
              <button class="btn-danger" onclick="deleteTask(${t.id})">ðŸ—‘</button>
            </div>
          `;
          c.appendChild(row);
        });

        // inline rename
        c.querySelectorAll(".title").forEach(el=>{
          el.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); el.blur(); }});
          el.addEventListener("blur", async ()=>{
            const id = Number(el.dataset.id);
            const title = el.innerText.trim();
            if(!title) return fetchTasks();
            await fetch(API + "/" + id, {
              method:"PUT", headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ title })
            });
            fetchTasks();
          });
        });

      }catch(err){
        console.error(err);
        showError("Failed to load tasks. Is the backend running on http://localhost:3000 ?");
      }
    }

    async function addTask(){
      const title = $("#taskInput").value.trim();
      const due = $("#dueInput").value || null;
      if(!title) return $("#taskInput").focus();
      await fetch(API, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ title, due })
      });
      $("#taskInput").value="";
      $("#dueInput").value="";
      fetchTasks();
    }

    async function toggleDone(id, done){
      await fetch(API + "/" + id, {
        method:"PUT", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ done: !done })
      });
      fetchTasks();
    }

    async function deleteTask(id){
      await fetch(API + "/" + id, { method:"DELETE" });
      fetchTasks();
    }

    async function updateDue(id, due){
      await fetch(API + "/" + id, {
        method:"PUT", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ due: due || null })
      });
      fetchTasks();
    }

    async function markAllDone(){
      await fetch(API + "/mark-all-done".replace("/tasks/tasks","/tasks"), { method:"PUT" });
      fetchTasks();
    }

    function setFilter(f){ currentFilter=f; fetchTasks(); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    // init
    document.getElementById("addBtn").addEventListener("click", addTask);
    document.getElementById("taskInput").addEventListener("keydown", e=>{ if(e.key==="Enter") addTask(); });
    fetchTasks();
  </script>
</body>
</html>
